{% extends "storefront/base.html" %}
{% load static %}
{% static 'storefront/images/product_placeholder.svg' as product_placeholder %}
{% block title %}Your Cart â€” AuroraMart{% endblock %}
{% block content %}
<h2>Your Cart</h2>
{% if cart_items %}
  <div class="page">
  <div class="section">
      {% for item in cart_items %}
      <div class="card" style="text-align:left; display:flex; align-items:center; gap:12px;">
        <img src="{{ item.product.display_image }}" alt="{{ item.product.name }}" style="width:96px; height:96px; object-fit:cover; border-radius:8px;">
        <div style="flex:1">
          <strong>{{ item.product.name }}</strong><br>
          <small class="muted">In stock: {{ item.product.stock }}</small>
          <div style="display:flex; align-items:center; gap:8px; margin-top:8px;">
            <form method="post" action="{% url 'storefront:cart_update' item.product.id %}">
              {% csrf_token %}
              <input type="hidden" name="action" value="decrement">
              <button class="chip" type="submit">-</button>
            </form>
            <form method="post" action="{% url 'storefront:cart_update' item.product.id %}">
              {% csrf_token %}
              <input type="number" name="quantity" value="{{ item.quantity }}" min="1" max="{{ item.product.stock }}" class="cart-qty" onchange="this.form.submit()">
              <noscript><button class="chip" type="submit">Update</button></noscript>
            </form>
            <form method="post" action="{% url 'storefront:cart_update' item.product.id %}">
              {% csrf_token %}
              <input type="hidden" name="action" value="increment">
              <button class="chip" type="submit">+</button>
            </form>
            <div class="cart-controls" style="margin-left:auto; display:flex; align-items:center; gap:12px;">
              <div class="cart-meta-amounts" style="text-align:right;">
                <div class="cart-meta-unit" style="margin-bottom:6px;">
                  {% if item.product.discount_percent %}
                    <div><small class="original-price">${{ item.product.price }}</small></div>
                    <div><strong>Unit:</strong> <span class="discounted-price">${{ item.unit_price }}</span></div>
                  {% else %}
                    <div><strong>Unit:</strong> ${{ item.product.price }}</div>
                  {% endif %}
                </div>
                <div class="cart-meta-subtotal" style="font-weight:700;">Subtotal: ${{ item.subtotal }}</div>
                {% if item.total_savings and item.total_savings > 0 %}
                  <div class="muted" style="color:#047857; margin-top:6px;">You saved ${{ item.total_savings }}</div>
                {% endif %}
              </div>
              <form method="post" action="{% url 'storefront:cart_remove' item.product.id %}">
                {% csrf_token %}
                <button class="btn-remove" type="submit" aria-label="Remove {{ item.product.name }} from cart">Remove</button>
              </form>
            </div>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
  <div class="section">
    <div class="cart-totals-row" style="display:flex; align-items:center; justify-content:space-between; max-width:960px; margin:0 auto;">
      <div class="cart-total"><strong>Total: </strong>${{ total }}</div>
      <div><a class="chip primary" href="{% url 'storefront:checkout' %}">Proceed to Checkout</a></div>
    </div>
  </div>
  </div>
  {% if complete_the_set %}
  <div class="section" style="max-width:960px; margin:0 auto;">
    <h3>Complete the set</h3>
    <p class="muted" style="max-width:960px; margin:0;">Customers often add these to the same basket.</p>
  <div class="fbt-grid">
      {% for rec in complete_the_set %}
      <a class="fbt-card" href="{% url 'storefront:product_detail' rec.id %}">
        <img src="{{ rec.display_image }}" alt="{{ rec.name }}">
        <div class="fbt-title">{{ rec.name }}</div>
        {% if rec.discount_percent %}
          <div class="fbt-price">${{ rec.get_display_price }}</div>
          <div class="fbt-meta original-price">${{ rec.price }}</div>
        {% else %}
          <div class="fbt-price">${{ rec.price }}</div>
        {% endif %}
      </a>
      {% endfor %}
    </div>
  </div>
  {% endif %}
{% else %}
  <p>Your cart is empty. <a href="{% url 'storefront:product_list' %}">Shop now</a>.</p>
{% endif %}
{% endblock %}