{% extends "storefront/base.html" %}
{% block title %}Checkout — AuroraMart{% endblock %}
{% block extra_head %}
<script src="https://js.stripe.com/v3/"></script>
<style>
  .secure-row{display:flex;align-items:center;gap:.5rem;padding:8px;background:#f8fafc;border-radius:8px;border:1px solid #e6edf6}
  .pci-badge{background:#ecfdf5;color:#065f46;padding:4px 8px;border-radius:999px;font-weight:700;font-size:0.8rem}
  #card-element { padding:12px; border-radius:8px; background:#fff; border:1px solid rgba(15,23,42,0.06); }
</style>
{% endblock %}

{% block content %}
<h2>Checkout</h2>
<form method="post" class="checkout-form" id="checkout-form">
  {% csrf_token %}

  <div class="section">
    <h3 class="section-header">Shipping Address</h3>
    <textarea name="address" rows="3" required class="form-input"></textarea>
  </div>

  <div class="section">
    <h3 class="section-header">Payment Method</h3>
    <select name="payment_method" required class="form-input">
      <option>Card</option>
      <option>PayNow</option>
      <option>Cash on Delivery</option>
    </select>
  </div>

  <div class="section">
    <h3 class="section-header">Card Details</h3>
    <div class="secure-row">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 1v2" stroke="#0f172a" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><rect x="3" y="5" width="18" height="14" rx="2" stroke="#0f172a" stroke-width="1.5"/></svg>
      <div>Secure payment processed by Stripe</div>
      <div style="margin-left:auto;"><span class="pci-badge">PCI compliant</span></div>
    </div>
    <div style="margin-top:12px;">
      <label for="card-name" style="display:block;margin-bottom:6px;font-weight:600;">Name on card</label>
      <input id="card-name" name="card_name" placeholder="Name on card" required class="form-input">
    </div>
    <div style="margin-top:12px;">
      <label for="card-element" style="display:block;margin-bottom:6px;font-weight:600;">Card</label>
      <div id="card-element"></div>
      <div id="card-errors" role="alert" class="muted" style="margin-top:8px; font-size:0.95em;"></div>
    </div>
  </div>

  <div class="section actions">
    <button class="btn btn-primary" id="place-order" type="submit">Place Order</button>
  </div>
</form>

<div class="section" style="margin-top:18px;">
  <h3>Order summary</h3>
  {% if cart_items %}
    <div style="display:flex; flex-direction:column; gap:8px;">
      {% for item in cart_items %}
        <div style="display:flex; justify-content:space-between;">
          <div>{{ item.product.name }} × {{ item.quantity }}</div>
          <div>${{ item.subtotal }}</div>
        </div>
      {% endfor %}
      <hr>
      <div style="display:flex; justify-content:space-between;">
        <div><strong>Total</strong></div>
        <div><strong>${{ total_price }}</strong></div>
      </div>
      {% if total_savings and total_savings > 0 %}
        <div style="color:#047857;">You saved ${{ total_savings }} on this order</div>
      {% endif %}
    </div>
  {% else %}
    <p class="muted">No items in cart.</p>
  {% endif %}
</div>

{% if complete_the_set %}
  <div class="section" style="margin-top:24px;">
    <h3>Complete the set</h3>
    <p class="muted">Customers frequently add these alongside the items in your cart.</p>
    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px;">
      {% for rec in complete_the_set %}
        <a class="card" href="{% url 'storefront:product_detail' rec.id %}">
          {% if rec.image %}
            <img src="{{ rec.image.url }}" alt="{{ rec.name }}" style="width:100%; height:140px; object-fit:cover; border-radius:8px; margin-bottom:8px;">
          {% endif %}
          <strong>{{ rec.name }}</strong>
          {% if rec.discount_percent %}
            <small class="text-muted"><span class="discounted-price">${{ rec.get_display_price }}</span> <span class="original-price">${{ rec.price }}</span></small>
          {% else %}
            <small class="text-muted">${{ rec.price }}</small>
          {% endif %}
        </a>
      {% endfor %}
    </div>
  </div>
{% endif %}
{% endblock %}

{% block extra_body %}
<script>
  // Read CSRF from cookie
  function getCookie(name) {
    const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
  }

  (function(){
    const stripeKey = '{{ stripe_publishable_key }}';
    if(!stripeKey) return; // keys not configured
    const stripe = Stripe(stripeKey);
    const elements = stripe.elements();
    const card = elements.create('card', {style: {base: {fontSize: '16px'}}});
    card.mount('#card-element');

    const form = document.getElementById('checkout-form');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      document.getElementById('place-order').disabled = true;
      const amount = Math.round({{ total_price }} * 100);
      try {
        const res = await fetch("{% url 'storefront:create_payment_intent' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({amount})
        });
        const data = await res.json();
        if(data.error){ throw data.error }
        const clientSecret = data.clientSecret;
        const result = await stripe.confirmCardPayment(clientSecret, {
          payment_method: { card: card, billing_details: { name: document.getElementById('card-name').value } }
        });
        if(result.error){
          document.getElementById('card-errors').textContent = result.error.message;
          document.getElementById('place-order').disabled = false;
        } else if(result.paymentIntent && result.paymentIntent.status === 'succeeded'){
          // Payment succeeded; submit the form to create the Order server-side (or redirect)
          form.submit();
        }
      } catch(err){
        document.getElementById('card-errors').textContent = err.toString();
        document.getElementById('place-order').disabled = false;
      }
    });
  })();
</script>
{% endblock %}