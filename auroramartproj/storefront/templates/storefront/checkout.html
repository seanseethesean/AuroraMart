{% extends "storefront/base.html" %}
{% block title %}Checkout — AuroraMart{% endblock %}
{% load static %}
{% static 'storefront/images/product_placeholder.svg' as product_placeholder %}
{% static 'storefront/images/paynow_qr.png' as paynow_qr %}
{% block extra_head %}
<style>
  .checkout-grid.columns-2{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .card-row{display:block}
  /* card section hidden when not paying by card */
  #card-section{display:block}
</style>
{% endblock %}

{% block content %}
<h2>Checkout</h2>
<form method="post" class="checkout-form" id="checkout-form">
  {% csrf_token %}

  <div class="section">
    <h3 class="section-header">Shipping Address</h3>
    <textarea name="address" rows="3" required class="form-input"></textarea>
  </div>

  <div class="section">
    <h3 class="section-header">Payment Method</h3>
    <select name="payment_method" required class="form-input">
      <option>Card</option>
      <option>PayNow</option>
      <option>Cash on Delivery</option>
    </select>
    <div id="paynow-section" style="display:none; margin-top:12px;">
      <div style="max-width:240px;">
        <img src="{{ paynow_qr }}" alt="PayNow QR" style="width:100%; height:auto; border-radius:8px;" onerror="this.style.display='none'; document.getElementById('paynow-fallback').style.display='block';">
        <div id="paynow-fallback" style="display:none; padding:10px; background:#fff; border:1px solid #e6edf6; border-radius:8px;">
          <!-- Inline simple QR-like fallback SVG -->
          <svg width="200" height="200" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="PayNow QR placeholder">
            <rect width="100%" height="100%" fill="#f8fafc"/>
            <rect x="10" y="10" width="40" height="40" fill="#0f172a"/>
            <rect x="150" y="10" width="40" height="40" fill="#0f172a"/>
            <rect x="10" y="150" width="40" height="40" fill="#0f172a"/>
            <g fill="#0f172a">
              <rect x="70" y="70" width="20" height="20"/>
              <rect x="100" y="70" width="20" height="20"/>
              <rect x="70" y="100" width="20" height="20"/>
            </g>
          </svg>
        </div>
        <div class="muted" style="margin-top:8px;">Open your banking app and scan the QR to pay</div>
      </div>
    </div>
  </div>

  <div class="section">
    <h3 class="section-header">Card Details</h3>
    <div id="card-section" style="margin-top:12px;">
      <div class="checkout-grid columns-2">
        <div class="card-row">
          <input name="card_name" placeholder="Name on card" required class="form-input">
        </div>

        <div class="card-row">
          <input name="card_number" placeholder="Card number" required class="form-input">
        </div>

        <div class="card-row">
          <input name="card_expiry" placeholder="MM/YY" required class="form-input">
        </div>

        <div class="card-row">
          <input name="card_cvv" placeholder="CVV" required class="form-input">
        </div>
      </div>

      <div id="card-errors" role="alert" class="muted" style="margin-top:8px; font-size:0.95em;"></div>
    </div>
  </div>

  <div class="section actions">
    <button class="btn btn-primary" id="place-order" type="submit">Place Order</button>
  </div>
</form>

<div class="section" style="margin-top:18px;">
  <h3>Order summary</h3>
  {% if cart_items %}
    <div style="display:flex; flex-direction:column; gap:8px;">
      {% for item in cart_items %}
        <div style="display:flex; justify-content:space-between;">
          <div>{{ item.product.name }} × {{ item.quantity }}</div>
          <div>${{ item.subtotal }}</div>
        </div>
      {% endfor %}
      <hr>
      <div style="display:flex; justify-content:space-between;">
        <div><strong>Total</strong></div>
        <div><strong>${{ total_price }}</strong></div>
      </div>
      {% if total_savings and total_savings > 0 %}
        <div style="color:#047857;">You saved ${{ total_savings }} on this order</div>
      {% endif %}
    </div>
  {% else %}
    <p class="muted">No items in cart.</p>
  {% endif %}
</div>

{% if complete_the_set %}
  <div class="section" style="margin-top:24px;">
    <h3>Complete the set</h3>
    <p class="muted">Customers frequently add these alongside the items in your cart.</p>
  <div class="fbt-grid">
      {% for rec in complete_the_set %}
        <a class="fbt-card" href="{% url 'storefront:product_detail' rec.id %}">
          <img src="{{ rec.display_image }}" alt="{{ rec.name }}">
          <div class="fbt-title">{{ rec.name }}</div>
          {% if rec.discount_percent %}
            <div class="fbt-price">${{ rec.get_display_price }}</div>
            <div class="fbt-meta original-price">${{ rec.price }}</div>
          {% else %}
            <div class="fbt-price">${{ rec.price }}</div>
          {% endif %}
        </a>
      {% endfor %}
    </div>
  </div>
{% endif %}
{% endblock %}

{% block extra_body %}

<script>
  (function(){
    const form = document.getElementById('checkout-form');
    const errorEl = document.getElementById('card-errors');
    const placeBtn = document.getElementById('place-order');

    function showError(msg){
      if(errorEl) errorEl.textContent = msg;
      if(placeBtn) placeBtn.disabled = false;
    }

    function clearError(){
      if(errorEl) errorEl.textContent = '';
    }

    function isExpiryValid(expiry){
      const m = expiry.trim().match(/^\s*(\d{2})\/(\d{2})\s*$/);
      if(!m) return false;
      let mm = parseInt(m[1], 10);
      let yy = parseInt(m[2], 10);
      if(mm < 1 || mm > 12) return false;
      const year = 2000 + yy;
      const now = new Date();
      if(year < now.getFullYear()) return false;
      if(year === now.getFullYear() && mm < (now.getMonth() + 1)) return false;
      return true;
    }

    function toggleCardSection(){
      const pm = (document.querySelector('select[name="payment_method"]') || {}).value || '';
      const cardSection = document.getElementById('card-section');
      const paynowSection = document.getElementById('paynow-section');
      const inputs = Array.from(document.querySelectorAll('#card-section input'));
      const isCard = pm.toLowerCase() === 'card';
      const isPayNow = pm.toLowerCase() === 'paynow';
      if(cardSection){
        cardSection.style.display = isCard ? 'block' : 'none';
      }
      if(paynowSection){
        paynowSection.style.display = isPayNow ? 'block' : 'none';
      }
      inputs.forEach(inp => {
        try{
          inp.required = isCard;
          inp.disabled = !isCard;
        }catch(_){
        }
      });
    }
    if(form){
      // initialize visibility
      toggleCardSection();
      // toggle on payment method change
      const pmSelect = document.querySelector('select[name="payment_method"]');
      if(pmSelect){
        pmSelect.addEventListener('change', function(){ clearError(); toggleCardSection(); });
      }

      form.addEventListener('submit', function(e){
        clearError();
        const pm = (document.querySelector('select[name="payment_method"]') || {}).value || '';
        if(pm.toLowerCase() !== 'card') return; // not card -> allow submit

        // Basic client-side validations (only when card selected)
        const cardName = (document.querySelector('input[name="card_name"]') || {}).value || '';
        const cardNumber = ((document.querySelector('input[name="card_number"]') || {}).value || '').replace(/\D/g, '');
        const cardExpiry = (document.querySelector('input[name="card_expiry"]') || {}).value || '';
        const cardCvv = (document.querySelector('input[name="card_cvv"]') || {}).value || '';

        if(!cardName.trim()){
          e.preventDefault(); showError('Please enter the name on the card.'); return;
        }
        if(!/^\d{16}$/.test(cardNumber)){
          e.preventDefault(); showError('Card number must be 16 digits.'); return;
        }
        if(!/^\d{3}$/.test(cardCvv.trim())){
          e.preventDefault(); showError('CVV must be 3 digits.'); return;
        }
        if(!isExpiryValid(cardExpiry)){
          e.preventDefault(); showError('Expiry must be MM/YY and not expired.'); return;
        }

        // If validations pass, allow normal form POST to server which will
        // perform the same server-side checks.
      });
    }
  })();
</script>

{% endblock %}